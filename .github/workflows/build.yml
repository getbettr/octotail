name: build

on:
  push:
    branches:
      - ci
      - dev
      - "!main"

permissions:
  contents: write

jobs:
  get-versions:
    name: get-versions
    runs-on: arc-octotail
    steps:
      - uses: actions/checkout@v4
      - name: Grab the version from pyproject.toml
        env:
          TEST_PYPI_SUFFIX: "a2"
        shell: bash
        run: |
          version="$(head -n5 pyproject.toml | grep -oE "version = \"[0-9\.]+\"" | cut -d'"' -f2)"
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "TEST_VERSION=${version}${TEST_PYPI_SUFFIX}" >> $GITHUB_ENV
    outputs:
      version: ${{ env.VERSION }}
      test_version: ${{ env.TEST_VERSION }}

  smoke-test:
    name: smoke-test
    runs-on: arc-octotail
    steps:
      - uses: actions/checkout@v4
      - name: Has uv
        id: has_uv
        run: |
          if command -v uv &> /dev/null; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        if: ${{ steps.has_uv.outputs.result == 'false' }}
      - name: Setup project with uv
        run: |
          uv python find 3.12 || uv python install 3.12
          uv venv
          uv sync --link-mode=copy
      - name: Run pycheck-parallel
        run: |
          source .venv/bin/activate
          ./hacks/pycheck-parallel

  publish-wheels:
    name: publish-wheels
    needs: [ "get-versions", "smoke-test" ]
    runs-on: arc-octotail
    steps:
      - uses: actions/checkout@v4
      - name: Has uv
        id: has_uv
        run: |
          if command -v uv &> /dev/null; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        if: ${{ steps.has_uv.outputs.result == 'false' }}
      - name: Setup project with uv
        run: |
          uv python find 3.12 || uv python install 3.12
          uv venv
      - name: Build wheels
        shell: bash
        run: |
          test_version="${{ needs.get-versions.outputs.test_version }}"
          uv build
          uvx --from=toml-cli toml set --toml-path=pyproject.toml project.version "${test_version}"
          uv build
      - name: Publish to test.pypi
        shell: bash
        env:
          TEST_PYPI_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
        run: |
          test_version="${{ needs.get-versions.outputs.test_version }}"
          uv publish --publish-url https://test.pypi.org/legacy/ --username=__token__ --password="$TEST_PYPI_TOKEN" "dist/*-${test_version}*"
      - name: Publish to pypi
        if: "github.ref == 'refs/heads/ci' && !contains(github.event.head_commit.message, '[cron]')"
        shell: bash
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          version="${{ needs.get-versions.outputs.version }}"
          test_version="${{ needs.get-versions.outputs.test_version }}"
          git checkout pyproject.toml
          find ./dist -name "*-${test_version}*" -delete
          uv publish --username=__token__ --password="$PYPI_TOKEN" "dist/*-${version}*"

  promote-release:
    if: "github.ref == 'refs/heads/no-ci' && !contains(github.event.head_commit.message, '[cron]')"
    name: promote-release
    needs: [ "publish-wheels", "get-versions" ]
    runs-on: arc-octotail
    steps:
      - uses: actions/checkout@v4
      - name: Promote release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          version="${{ needs.get-versions.outputs.version }}"
          gh release edit "v${version}" --draft=false --latest
